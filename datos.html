<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Formulario de Datos</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <div class="barra-pasos">
    <img src="Logo-Seguros-SURA.jpg" alt="Logo SURA" class="logo-pasos" />
    <div class="paso activo">1. Cotiza tu SOAT</div>
    <div class="paso activo">2. Ingresa los datos</div>
    <div class="paso">3. Realiza el pago</div>
    <div class="paso">4. Recibe tu póliza</div>
  </div>

  <div class="contenedor-horizontal">
    <div class="info-vehiculo">
      <h3>Información del vehículo</h3>
      <div id="datosResumen" class="resumen-box"></div>

      <label for="modelo">Modelo:</label>
      <select id="modelo" required>
        <option value="">Seleccione el modelo</option>
      </select>

      <label for="marca">Marca:</label>
      <input type="text" id="marca" required placeholder="Ej: Renault, Yamaha..." />
    </div>

    <div class="formulario-central">
      <h2>Datos del tomador</h2>
      <form id="formularioDatos">
        <label for="inicioVigencia">Fecha inicio de vigencia del SOAT:</label>
        <input type="date" id="inicioVigencia" required />

        <label for="nombres">Nombres y apellidos:</label>
        <input type="text" id="nombres" required />

        <label for="tipoDocumento">Tipo de documento:</label>
        <select id="tipoDocumento" required>
          <option value="">Seleccione una opción</option>
          <option value="CC">Cédula de ciudadanía</option>
          <option value="CE">Cédula de extranjería</option>
          <option value="NIT">NIT</option>
          <option value="TI">Tarjeta de identidad</option>
          <option value="PAS">Pasaporte</option>
        </select>

        <label for="documento">Número de documento:</label>
        <input type="text" id="documento" required />

        <label for="email">Correo electrónico:</label>
        <input type="email" id="email" required />

        <label for="fechaExpedicion">Fecha de expedición del documento:</label>
        <input type="date" id="fechaExpedicion" required />

        <label for="celular">Celular:</label>
        <input type="tel" id="celular" required />

        <label for="direccion">Dirección:</label>
        <input type="text" id="direccion" required />

        <label for="ciudad">Ciudad de circulación:</label>
        <input type="text" id="ciudad" required />
      </form>
    </div>

    <div class="valor-pago-lateral">
      <h3>Valor a pagar:</h3>
      <p id="valorPagar" class="monto-pago">$640.000</p>
      <p class="nota-pago">*Este es un valor aproximado. Antes de que pagues, verás el costo real del SOAT.</p>
      <label class="checkbox-linea">
        <input type="checkbox" id="aceptar" required />
        Acepto los términos y condiciones
      </label>
      <button type="submit" form="formularioDatos" class="btn-pagar">Pagar</button>
    </div>
  </div>

  <footer class="footer-sura">
    <div class="footer-container">
      <p>© 2024 Suramericana S.A. Todos los derechos reservados. SOAT es un producto de aseguramiento obligatorio en Colombia.</p>
      <p>Este sitio web es operado por Suramericana S.A. Vigilado por la Superintendencia Financiera de Colombia.</p>
    </div>
  </footer>

  <script>
    const params = new URLSearchParams(window.location.search);
    const placa = params.get("placa");
    const clase = params.get("clase");
    const subtipo = params.get("subtipo");
    const edad = params.get("edad");
    const valor = params.get("valor");

    document.getElementById("datosResumen").innerHTML = `
      <p><strong>Placa:</strong> ${placa}</p>
      <p><strong>Clase:</strong> ${clase}</p>
      <p><strong>Subtipo:</strong> ${subtipo}</p>
      ${edad ? `<p><strong>Edad:</strong> ${edad}</p>` : ""}
    `;

    if (valor) {
      document.getElementById("valorPagar").textContent = valor;
    }

    const modeloSelect = document.getElementById("modelo");
    for (let year = 2028; year >= 1980; year--) {
      const option = document.createElement("option");
      option.value = year;
      option.textContent = year;
      modeloSelect.appendChild(option);
    }

    const hoy = new Date().toISOString().split("T")[0];
    document.getElementById("inicioVigencia").setAttribute("min", hoy);
    document.getElementById("fechaExpedicion").setAttribute("max", hoy);

    document.getElementById("formularioDatos").addEventListener("submit", async e => {
      e.preventDefault();

      const email = document.getElementById("email").value.trim();
      const aceptar = document.getElementById("aceptar").checked;

      if (!email.includes("@")) {
        alert("⚠️ El correo electrónico no es válido.");
        return;
      }

      if (!aceptar) {
        alert("⚠️ Debes aceptar los términos y condiciones para continuar.");
        return;
      }

      const valorTexto = document.getElementById("valorPagar").textContent;

      try {
        const response = await fetch("http://localhost:3000/crear-checkout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ valor: valorTexto })
        });

        const data = await response.json();

        if (data.url) {
          window.open(data.url, "_blank");
        } else {
          alert("❌ No se pudo generar el link de pago.");
        }
      } catch (error) {
        console.error(error);
        alert("❌ Error al generar el link de pago.");
      }
    });
  </script>
</body>
</html>
